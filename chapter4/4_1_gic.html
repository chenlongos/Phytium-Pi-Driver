<!DOCTYPE HTML>
<html lang="zh-CN" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>GIC驱动 - 飞腾派驱动开发实验指导书</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">飞腾派驱动开发实验指导书</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="41-gic驱动"><a class="header" href="#41-gic驱动">4.1 gic驱动</a></h1>
<h2 id="gic-的硬件原理"><a class="header" href="#gic-的硬件原理">GIC 的硬件原理</a></h2>
<p>Generic Interrupt Controller (GIC) 是 ARM 架构用于管理中断的核心硬件模块，负责接收、优先级排序、屏蔽和分发中断请求（IRQ）到处理器核心，广泛应用于 ARMv7-A/R 和 ARMv8-A/R 的多核 SoC（如飞腾 E2000）。它通过高效的中断管理支持外设（如 UART、I2C）和软件触发的中断处理。</p>
<ul>
<li>主要组件：
<ul>
<li><strong>分发器（Distributor, GICD）</strong>：管理所有中断源，设置优先级、目标 CPU 和使能状态，包含寄存器如 GICD_CTLR（使能）、GICD_ISENABLER（中断使能）、GICD_IPRIORITYR（优先级）、GICD_ITARGETSR（目标 CPU）。</li>
<li><strong>CPU 接口（CPU Interface, GICC）</strong>：每个核心一个接口，接收中断并触发异常，包含寄存器如 GICC_CTLR（使能）、GICC_PMR（优先级屏蔽）、GICC_IAR（中断 ID 读取）、GICC_EOIR（中断结束）。</li>
<li><strong>重分发器（Redistributor, GICR，GICv3 引入）</strong>：管理每个核心的私有中断（PPI）和局部中断（LPI），包含 GICR_CTLR（控制）和 GICR_TYPER（类型）。</li>
</ul>
</li>
</ul>
<p>GIC 支持多种中断类型：</p>
<ul>
<li><strong>SGI（Software Generated Interrupt）</strong>：ID 0~15，用于核间通信。</li>
<li><strong>PPI（Private Peripheral Interrupt）</strong>：ID 16~31，如定时器。</li>
<li><strong>SPI（Shared Peripheral Interrupt）</strong>：ID 32~1019，如 UART、I2C。</li>
<li><strong>LPI（Locality-specific Peripheral Interrupt, GICv3）</strong>：ID 8192~16K，支持虚拟化。</li>
</ul>
<p>工作流程包括中断触发、分发器优先级排序、路由到目标 CPU、CPU 接口触发异常、处理完成后标记结束。GICv3（飞腾派可能使用）支持多达 216 核和 2K 个 SPI，提供系统寄存器访问。</p>
<h2 id="飞腾派的-gic-设备"><a class="header" href="#飞腾派的-gic-设备">飞腾派的 GIC 设备</a></h2>
<p>飞腾派（Phytium Pi）基于飞腾 E2000 处理器（ARMv8-A），其 GIC 设备遵循 GICv3 架构，管理多核环境下的中断。分发器（GICD）位于基址 0xFF84_1000，负责全局中断配置；重分发器（GICR）位于 0xFF84_2000，处理私有中断。</p>
<ul>
<li>
<p>硬件特性：</p>
<ul>
<li>
<p><strong>基址</strong>：GICD 0xFF84_1000，GICR 0xFF84_2000。</p>
</li>
<li>
<p><strong>中断支持</strong>：SGI（ID 0~15，核间通信）、PPI（ID 16~31，如定时器）、SPI（ID 32~1019，如 UART IRQ 24）。</p>
</li>
<li>
<p><strong>核数</strong>：E2000 支持 2~4 核。</p>
</li>
<li>
<p><strong>设备树</strong>（phytium_pi.dts）：</p>
</li>
<li>
<pre><code class="language-shell">gic: interrupt-controller@ff841000 {
    compatible = "arm,gic-v3";
    reg = &lt;0x0 0xFF841000 0x0 0x1000&gt;, &lt;0x0 0xFF842000 0x0 0x20000&gt;;
    interrupt-controller;
    #interrupt-cells = &lt;3&gt;;
};
</code></pre>
</li>
</ul>
</li>
</ul>
<h2 id="gic-时序图"><a class="header" href="#gic-时序图">GIC 时序图</a></h2>
<p>飞腾派 GIC 处理 UART 中断（SPI，IRQ 24，基址 0x2800_E000）的时序如下：</p>
<ul>
<li>参与者：
<ul>
<li>UART 外设（0x2800_E000）</li>
<li>GIC 分发器（GICD，0xFF84_1000）</li>
<li>GIC CPU 接口（GICC，CPU 0）</li>
<li>E2000 CPU 核心（CPU 0）</li>
</ul>
</li>
</ul>
<p>UART 接收数据触发 IRQ 24，信号到达 GICD，检查使能（GICD_ISENABLER[0]）、优先级（GICD_IPRIORITYR[6]，如 0xA0）和目标（GICD_ITARGETSR[6]，CPU 0）。GICD 转发中断到 GICC，GICC 检查优先级屏蔽（GICC_PMR，如 0xF0），读取 GICC_IAR 返回 IRQ 24，触发 CPU 0 的异常处理（uart.rs）。CPU 0 完成后写 GICC_EOIR，GICC 通知 GICD 更新状态。总延迟约 20~50 ns（100 MHz 时钟）。</p>
<pre class="mermaid">sequenceDiagram
    participant UART as UART (0x2800_E000)
    participant GICD as GIC Distributor (0xFF84_1000)
    participant GICC as GIC CPU Interface (CPU 0)
    participant CPU as E2000 CPU Core 0

    UART-&gt;&gt;GICD: IRQ 24 (SPI)
    GICD-&gt;&gt;GICD: Check GICD_ISENABLER[0] (IRQ 24 enabled)
    GICD-&gt;&gt;GICD: Read GICD_IPRIORITYR[6] (Priority 0xA0)
    GICD-&gt;&gt;GICD: Read GICD_ITARGETSR[6] (Target CPU 0)
    GICD-&gt;&gt;GICC: Forward IRQ 24
    GICC-&gt;&gt;GICC: Check GICC_PMR (0xF0)
    GICC-&gt;&gt;CPU: Deliver IRQ 24 (GICC_IAR)
    CPU-&gt;&gt;CPU: Handle UART interrupt (uart.rs)
    CPU-&gt;&gt;GICC: Write GICC_EOIR (IRQ 24 complete)
    GICC-&gt;&gt;GICD: Notify completion
    GICD-&gt;&gt;GICD: Update interrupt status
</pre>
<h2 id="飞腾派-gic-驱动-api-调用表"><a class="header" href="#飞腾派-gic-驱动-api-调用表">飞腾派 GIC 驱动 API 调用表</a></h2>
<p>飞腾派 GIC 驱动（gic.rs）提供以下 API，用于初始化和处理中断，适配 GICv2 架构。表中列出函数、参数、返回值及功能描述：</p>
<div class="table-wrapper"><table><thead><tr><th><strong>函数名</strong></th><th><strong>参数</strong></th><th><strong>返回值</strong></th><th><strong>功能描述</strong></th></tr></thead><tbody>
<tr><td><code>set_enable</code></td><td><code>irq_num: usize</code>, <code>enabled: bool</code></td><td>无</td><td>使能或禁用指定中断（IRQ），通过 <code>GICD_ISENABLER</code> 寄存器控制。</td></tr>
<tr><td><code>register_handler</code></td><td><code>irq_num: usize</code>, <code>handler: IrqHandler</code></td><td><code>bool</code></td><td>注册中断处理程序，成功时使能中断并返回 <code>true</code>，失败返回 <code>false</code>。</td></tr>
<tr><td><code>dispatch_irq</code></td><td><code>_unused: usize</code></td><td>无</td><td>分发中断，读取 <code>GICC_IAR</code> 获取 IRQ 号，调用注册的处理程序，完成后写 <code>GICC_EOIR</code>。</td></tr>
<tr><td><code>init_primary</code></td><td>无</td><td>无</td><td>初始化主核的 GICD 和 GICC，设置分发器和 CPU 接口以启用中断处理。</td></tr>
<tr><td><code>init_secondary</code></td><td>无</td><td>无</td><td>初始化从核的 GICC，仅在 SMP（多核）模式下调用，配置 CPU 接口。</td></tr>
</tbody></table>
</div>
<h2 id="gic-设备寄存器信息"><a class="header" href="#gic-设备寄存器信息">GIC 设备寄存器信息</a></h2>
<h3 id="寄存器信息与基地址"><a class="header" href="#寄存器信息与基地址">寄存器信息与基地址</a></h3>
<p>飞腾派 GIC 设备的基地址和寄存器分布如下：</p>
<ul>
<li>分发器（GICD）基地址：0xFF84_1000
<ul>
<li>管理所有中断（SGI、PPI、SPI）的使能、优先级和路由。</li>
</ul>
</li>
<li>重分发器（GICR）基地址：0xFF84_2000
<ul>
<li>每个 CPU 核心一个重分发器，管理 PPI 和 SGI（GICv3 支持局部中断 LPI，但飞腾派可能不使用）。</li>
</ul>
</li>
<li>CPU 接口（GICC）基地址：0xFF85_1000（假设，位于 GICD+0x10000，需手册验证）。
<ul>
<li>每个核心一个接口，处理中断确认和结束。</li>
</ul>
</li>
</ul>
<h3 id="关键寄存器及位域"><a class="header" href="#关键寄存器及位域">关键寄存器及位域</a></h3>
<p>以下为飞腾派 GIC 设备涉及的关键寄存器及其位域功能，基于 GICv3 规范和飞腾派硬件上下文。</p>
<h4 id="分发器寄存器gicd基址-0xff84_1000"><a class="header" href="#分发器寄存器gicd基址-0xff84_1000">分发器寄存器（GICD，基址 0xFF84_1000）</a></h4>
<p>分发器管理所有中断的全局配置，支持 SGI（ID 0~15）、PPI（ID 16~31）和 SPI（ID 32~1019）。</p>
<ul>
<li>GICD_CTLR (0x0000, 读写)
<ul>
<li>功能：控制分发器使能和模式。</li>
<li>位域：
<ul>
<li><strong>[0] EnableGrp1NS</strong>：使能非安全组 1 中断（1=使能，0=禁用）。</li>
<li><strong>[1] EnableGrp1S</strong>：使能安全组 1 中断。</li>
<li><strong>[4] ARE_NS</strong>：非安全地址重定向使能（GICv3）。</li>
<li><strong>[5] ARE_S</strong>：安全地址重定向使能。</li>
</ul>
</li>
<li>飞腾派应用：设置 EnableGrp1NS=1，使能 SPI（如 UART IRQ 24）。</li>
</ul>
</li>
<li>GICD_ISENABLERn (0x0100~0x017C, 读写)
<ul>
<li>功能：使能中断（每寄存器控制 32 个中断）。</li>
<li>位域：每位对应一个中断 ID（0=禁用，1=使能）。</li>
<li>飞腾派应用：GICD_ISENABLER[0] 的 bit 24 使能 UART IRQ 24。</li>
</ul>
</li>
<li>GICD_IPRIORITYRn (0x0400~0x07FC, 读写)
<ul>
<li>功能：设置中断优先级（每寄存器 4 个中断，8 位/中断）。</li>
<li>位域：每个中断优先级 0x00（最高）~0xFF（最低）。</li>
<li>飞腾派应用：UART IRQ 24 优先级设为 0xA0（GICD_IPRIORITYR[6]）。</li>
</ul>
</li>
<li>GICD_ITARGETSRn (0x0800~0x0BFC, 读写, GICv3 非系统寄存器模式)
<ul>
<li>功能：设置中断目标 CPU（每寄存器 4 个中断，8 位/CPU）。</li>
<li>位域：每 8 位表示目标 CPU 掩码（bit 0=CPU 0）。</li>
<li>飞腾派应用：IRQ 24 路由到 CPU 0（GICD_ITARGETSR[6] bit 0=1）。</li>
</ul>
</li>
</ul>
<h4 id="cpu-接口寄存器gicc基址-0xff85_1000"><a class="header" href="#cpu-接口寄存器gicc基址-0xff85_1000">CPU 接口寄存器（GICC，基址 0xFF85_1000）</a></h4>
<p>CPU 接口处理核心接收的中断，触发异常并标记完成。</p>
<ul>
<li>GICC_CTLR (0x0000, 读写)
<ul>
<li>功能：控制 CPU 接口使能和模式。</li>
<li>位域：
<ul>
<li><strong>[0] EnableGrp1</strong>：使能组 1 中断（1=使能）。</li>
<li><strong>[1] FIQEn</strong>：使能 FIQ 模式（飞腾派通常禁用）。</li>
</ul>
</li>
<li>飞腾派应用：设置 EnableGrp1=1 接收 SPI。</li>
</ul>
</li>
<li>GICC_PMR (0x0004, 读写)
<ul>
<li>功能：设置优先级屏蔽阈值，仅处理高于此值的中断。</li>
<li>位域：8 位优先级（0x00~0xFF）。</li>
<li>飞腾派应用：设为 0xF0，允许优先级 &lt;0xF0 的中断（如 0xA0）。</li>
</ul>
</li>
<li>GICC_IAR (0x000C, 只读)
<ul>
<li>功能：读取当前中断 ID。</li>
<li>位域：10 位中断 ID（0~1019）。</li>
<li>飞腾派应用：读取 IRQ 24（UART 中断）。</li>
</ul>
</li>
<li>GICC_EOIR (0x0010, 只写)
<ul>
<li>功能：标记中断处理完成。</li>
<li>位域：写入中断 ID。</li>
<li>飞腾派应用：写入 IRQ 24 结束处理。</li>
</ul>
</li>
</ul>
<h4 id="重分发器寄存器gicr基址-0xff84_2000"><a class="header" href="#重分发器寄存器gicr基址-0xff84_2000">重分发器寄存器（GICR，基址 0xFF84_2000）</a></h4>
<p>重分发器管理每个核心的 PPI 和 SGI（飞腾派不使用 LPI）。</p>
<ul>
<li>GICR_CTLR (0x0000, 读写)
<ul>
<li>功能：控制重分发器使能。</li>
<li>位域：
<ul>
<li><strong>[0] EnableLPIs</strong>：使能局部中断（飞腾派禁用）。</li>
</ul>
</li>
<li>飞腾派应用：通常设为 0，仅处理 PPI/SGI。</li>
</ul>
</li>
<li>GICR_TYPER (0x0008, 只读)
<ul>
<li>功能：标识 CPU 核心和 GIC 特性。</li>
<li>位域：
<ul>
<li><strong>[0:7] ProcessorNumber</strong>：核心 ID。</li>
<li><strong>[32] Last</strong>：是否为最后一个重分发器。</li>
</ul>
</li>
<li>飞腾派应用：标识 E2000 的 2~4 核。</li>
</ul>
</li>
</ul>
<h2 id="gic-驱动实现"><a class="header" href="#gic-驱动实现">GIC 驱动实现</a></h2>
<p>飞腾派 GIC 驱动基于 GICv2 架构（arm_gicv2），通过 safe-mmio 访问寄存器（GICD 0xFF84_1000，GICC 0xFF85_1000），支持中断使能、注册、分发和初始化。以下从常量、数据结构到每个 API 的实现逐一讲解。</p>
<h3 id="常量与数据结构"><a class="header" href="#常量与数据结构">常量与数据结构</a></h3>
<p>驱动定义了关键常量和数据结构，为中断管理提供基础支持。</p>
<ul>
<li>常量：
<ul>
<li>MAX_IRQ_COUNT: usize = 1024：最大中断数量（GICv2 支持 ID 0~1019）。</li>
<li>TIMER_IRQ_NUM: usize：定时器 PPI（ID 14，translate_irq 转换为全局 ID）。</li>
<li>UART_IRQ_NUM: usize：UART SPI（通过 axconfig::UART_IRQ，如 IRQ 24）。</li>
<li>GICD_BASE: PhysAddr：分发器基址（0xFF84_1000，axconfig::GICD_PADDR）。</li>
<li>GICC_BASE: PhysAddr：CPU 接口基址（0xFF85_1000，axconfig::GICC_PADDR）。</li>
</ul>
</li>
<li>数据结构：
<ul>
<li>GICD: SpinNoIrq<GicDistributor>：静态分发器实例，使用 SpinNoIrq 确保多核安全，初始化为 GicDistributor::new(phys_to_virt(GICD_BASE))。</li>
<li>GICC: GicCpuInterface：静态 CPU 接口实例，无锁（每个核心独占），初始化为 GicCpuInterface::new(phys_to_virt(GICC_BASE))。</li>
<li>依赖 arm_gicv2 的 GicDistributor 和 GicCpuInterface，提供寄存器操作（如 GICD_CTLR, GICC_IAR）。</li>
</ul>
</li>
</ul>
<h3 id="api-实现讲解"><a class="header" href="#api-实现讲解">API 实现讲解</a></h3>
<p><strong>set_enable(irq_num: usize, enabled: bool)</strong></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn set_enable(irq_num: usize, enabled: bool) {
    trace!("GICD set enable: {} {}", irq_num, enabled);
    GICD.lock().set_enable(irq_num as _, enabled);
}
<span class="boring">}</span></code></pre></pre>
<p><strong>功能</strong>：使能或禁用指定中断（IRQ），通过 GICD_ISENABLER 寄存器设置。</p>
<p><strong>实现</strong>：</p>
<ul>
<li>使用 trace! 记录中断号和使能状态（如 IRQ 24，UART）。</li>
<li>调用 GICD.lock().set_enable，访问 GicDistributor 的 set_enable 方法，操作 GICD_ISENABLERn（每寄存器 32 位，bit 对应 IRQ）。</li>
<li>飞腾派应用：使能 UART IRQ 24（GICD_ISENABLER[0] 的 bit 24）。</li>
</ul>
<p><strong>register_handler(irq_num: usize, handler: IrqHandler) -&gt; bool</strong></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn register_handler(irq_num: usize, handler: IrqHandler) -&gt; bool {
    trace!("register handler irq {}", irq_num);
    crate::irq::register_handler_common(irq_num, handler)
}
<span class="boring">}</span></code></pre></pre>
<p><strong>功能</strong>：为指定中断注册处理程序，成功时使能中断并返回 true。</p>
<p><strong>实现</strong>：</p>
<ul>
<li>使用 trace! 记录中断号（如 IRQ 24）。</li>
<li>调用 crate::irq::register_handler_common，将 handler（IrqHandler 类型）注册到中断表。</li>
<li>成功注册后，自动调用 set_enable(irq_num, true)（register_handler_common 内部实现）。</li>
</ul>
<p><strong>dispatch_irq(_unused: usize)</strong></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn dispatch_irq(_unused: usize) {
    GICC.handle_irq(|irq_num| crate::irq::dispatch_irq_common(irq_num as _));
}
<span class="boring">}</span></code></pre></pre>
<p><strong>功能</strong>：分发中断，读取中断 ID 并调用注册的处理程序。</p>
<p><strong>实现</strong>：</p>
<ul>
<li>调用 GICC.handle_irq，读取 GICC_IAR 获取中断 ID（如 IRQ 24）。</li>
<li>通过闭包调用 crate::irq::dispatch_irq_common，查找中断表，执行注册的处理程序。</li>
<li>完成后写 GICC_EOIR 标记中断结束。</li>
</ul>
<p><strong>init_primary()</strong></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub(crate) fn init_primary() {
    info!("Initialize GICv2...");
    GICD.lock().init();
    GICC.init();
}
<span class="boring">}</span></code></pre></pre>
<p><strong>功能</strong>：初始化主核的 GICD 和 GICC，启用中断处理。</p>
<p><strong>实现</strong>：</p>
<ul>
<li>使用 info! 记录初始化日志（通过 UART2 输出，基址 0x2800_E000）。</li>
<li>调用 GICD.lock().init()，配置分发器：
<ul>
<li>设置 GICD_CTLR（如 EnableGrp1NS=1）。</li>
<li>初始化 GICD_IPRIORITYR（默认优先级，如 0xA0）。</li>
<li>配置 GICD_ITARGETSR（目标 CPU）。</li>
</ul>
</li>
<li>调用 GICC.init()，配置 CPU 接口：
<ul>
<li>设置 GICC_CTLR（EnableGrp1=1）。</li>
<li>配置 GICC_PMR（如 0xF0）。</li>
</ul>
</li>
</ul>
<p><strong>init_secondary()</strong></p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[cfg(feature = "smp")]
pub(crate) fn init_secondary() {
    GICC.init();
}
<span class="boring">}</span></code></pre></pre>
<p><strong>功能</strong>：初始化从核的 GICC，仅在多核（SMP）模式下使用。</p>
<p><strong>实现</strong>：</p>
<ul>
<li>调用 GICC.init()，配置从核的 CPU 接口（GICC_CTLR, GICC_PMR）。</li>
<li>不涉及 GICD（由主核初始化）。</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../chapter4/chapter_4.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../chapter4/4_2_i2c_interrupt.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../chapter4/chapter_4.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../chapter4/4_2_i2c_interrupt.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
