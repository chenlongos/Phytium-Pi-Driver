<!DOCTYPE HTML>
<html lang="zh-CN" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>eMMC驱动 - 飞腾派驱动开发实验指导书</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">飞腾派驱动开发实验指导书</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="72-emmc驱动"><a class="header" href="#72-emmc驱动">7.2 eMMC驱动</a></h1>
<h3 id="emmc-设备原理"><a class="header" href="#emmc-设备原理">eMMC 设备原理</a></h3>
<p>eMMC（embedded Multi-Media Card）是一种嵌入式多媒体卡标准，专为移动设备和嵌入式系统设计，集成 NAND 闪存和控制器于单一芯片中。eMMC 原理基于主机-从机模型，主机（如处理器）通过命令、数据和响应线控制从机（eMMC 卡）。它遵循 JEDEC 标准，支持 1/4/8 位数据总线，速率从 HS200（200 MB/s）到 HS400（400 MB/s）。eMMC 工作流程包括初始化（CMD0 复位, CMD1 OCR 查询, CMD2 CID 获取, CMD3 RCA 分配, CMD7 选择卡, CMD6 切换模式）、数据传输（CMD17/18 单/多块读, CMD24/25 单/多块写）和错误处理（CRC 校验, 重试机制）。控制器内部处理闪存管理（如磨损均衡、坏块处理、ECC 纠错），主机通过 SDMMC 控制器访问 eMMC，文件系统通常为 FAT32 或 ext4。eMMC 与 SD 卡的区别在于集成控制器和固定封装，支持 Boot Partition 用于启动镜像加载。</p>
<ul>
<li>关键特性：
<ul>
<li><strong>容量</strong>：eMMC 5.1 支持 4GB~1TB，分为用户区和引导区。</li>
<li><strong>接口</strong>：8 位数据线（DAT0~7）、命令线（CMD）、时钟线（CLK）、电源（VCC/VSS）。</li>
<li><strong>模式</strong>：默认模式 (25 MHz), 高速模式 (HS200/HS400), DDR 模式 (双边沿采样)。</li>
<li><strong>电源管理</strong>：支持低功耗睡眠模式和快速唤醒。</li>
</ul>
</li>
</ul>
<p>eMMC 的优势在于高集成度、低功耗和可靠性，适用于飞腾派等嵌入式板卡的启动和存储，传输块大小固定 512 字节，支持多分区。</p>
<hr />
<h3 id="飞腾派-emmc-设备"><a class="header" href="#飞腾派-emmc-设备">飞腾派 eMMC 设备</a></h3>
<p>飞腾派（Phytium Pi）开发板的 eMMC 设备集成在 D2000 处理器中，支持 eMMC 5.1 规范，提供 onboard eMMC 存储（8/16/32GB 选项）用于操作系统安装和数据持久化。设备控制器基址为 0x28008000，支持 1/4/8 位总线宽度，最大速率 50 MHz (SDR25 模式)，带宽 25 MB/s。飞腾派 eMMC 设备通过 MMC 控制器实现，支持 HS200 模式和 Boot Partition，用于加载 ArceOS 镜像（如 arceos.img）。设备树（phytium_pi.dts）定义 emmc 节点，配置文件（aarch64-phytium-pi.toml）包含 MMIO 区域 [0x28008000, 0x1000]。驱动在 ArceOS 中通过 axdriver_mmc 模块实现，支持初始化命令（如 CMD0/CMD8）和数据块传输，适用于 SD 卡/eMMC boot。</p>
<ul>
<li>硬件特性：
<ul>
<li><strong>接口</strong>：onboard eMMC 芯片，支持热插拔 SD 卡槽扩展。</li>
<li><strong>中断</strong>：IRQ 24，通过 GIC 路由 SPI，用于传输完成和错误。</li>
<li><strong>时钟</strong>：50 MHz (MMC_CLK)，支持 DDR 模式。</li>
<li><strong>扩展</strong>：支持 SDIO 设备（如 WiFi 模块）。</li>
</ul>
</li>
</ul>
<p>飞腾派的 eMMC 设备通过 PAD (0x32B30000) 配置引脚（如 DAT0~7, CMD, CLK），MIO (0x2801_4000~0x2803_2000) 选择功能，适用于启动和存储场景。</p>
<hr />
<h3 id="飞腾派-emmc-设备时序图"><a class="header" href="#飞腾派-emmc-设备时序图">飞腾派 eMMC 设备时序图</a></h3>
<p>飞腾派 eMMC 设备时序以单块读操作（CMD17）为例，涉及 MMC 控制器（基址 0x28008000）、eMMC 芯片和数据总线（DAT0~7）。主机发送 CMD17（读地址），eMMC 返回 R1 响应（状态），然后传输数据块（512 字节 + CRC），结束后触发中断（IRQ 24）通知 CPU。总延迟约 1~10 ms（50 MHz 时钟），依赖总线宽度（1/4/8 位）。</p>
<pre class="mermaid">sequenceDiagram
    participant Host as MMC 控制器 (0x28008000)
    participant eMMC as eMMC 芯片
    participant Bus as 数据总线 (DAT0-7)

    Host-&gt;&gt;eMMC: 发送 CMD17 (读命令, 地址)
    eMMC-&gt;&gt;Host: 返回 R1 响应 (状态, bit 0-7)
    eMMC-&gt;&gt;Bus: 传输数据块 (512 字节 + CRC)
    Bus-&gt;&gt;Host: 数据到达 FIFO
    Host-&gt;&gt;Host: 触发中断 (IRQ 24, GIC SPI)
    Host-&gt;&gt;eMMC: 等待结束位
</pre>
<h4 id="时序分析"><a class="header" href="#时序分析">时序分析</a></h4>
<p>命令阶段：CMD 线传输 48 位命令（CRC7 校验），响应延迟 &lt;1 ms。数据阶段：DAT 线传输块数据，8 位宽度下速率 50 MB/s，CRC16 校验完整性。中断阶段：传输完成后控制器触发 IRQ 24，GIC 路由到 CPU 0。</p>
<hr />
<h2 id="相关寄存器信息位域及基地址"><a class="header" href="#相关寄存器信息位域及基地址">相关寄存器信息、位域及基地址</a></h2>
<p>飞腾派 eMMC 设备寄存器基于 MMC 控制器（基址 0x28008000），支持命令、数据和中断配置。以下是关键寄存器、位域和基地址信息。</p>
<ul>
<li>
<p><strong>基址</strong>：MMC 控制器基址 0x28008000。</p>
</li>
<li>
<p>寄存器表：</p>
<div class="table-wrapper"><table><thead><tr><th><strong>寄存器</strong></th><th><strong>偏移</strong></th><th><strong>功能</strong></th><th><strong>关键位域</strong></th></tr></thead><tbody>
<tr><td>MMC_CMD</td><td>0x00</td><td>命令寄存器</td><td>CMD_IDX (bit 0-5: 命令索引，如 CMD17=17), CMD_RESP (bit 6-7: 响应类型)</td></tr>
<tr><td>MMC_ARG</td><td>0x04</td><td>命令参数寄存器</td><td>ARG (bit 0-31: 命令参数，如读地址)</td></tr>
<tr><td>MMC_RESP0</td><td>0x08</td><td>响应寄存器 0</td><td>RESP (bit 0-31: R1/R3/R4/R5 响应)</td></tr>
<tr><td>MMC_DATA_CTRL</td><td>0x0C</td><td>数据控制寄存器</td><td>BLOCK_SIZE (bit 0-11: 512=0x200), DMA_EN (bit 0), DIR (bit 1: 0=写, 1=读)</td></tr>
<tr><td>MMC_INTR_EN</td><td>0x10</td><td>中断使能寄存器</td><td>TX_COMPLETE_EN (bit 0), RX_COMPLETE_EN (bit 1), ERR_INTR_EN (bit 2)</td></tr>
<tr><td>MMC_INTR_STATUS</td><td>0x14</td><td>中断状态寄存器</td><td>TX_INTR (bit 0), RX_INTR (bit 1)</td></tr>
<tr><td>MMC_CLK_DIV</td><td>0x18</td><td>时钟分频寄存器</td><td>DIV (bit 0-7: 分频值，50 MHz / DIV)</td></tr>
</tbody></table>
</div></li>
</ul>
<p>MMC_CMD 寄存器位域：</p>
<ul>
<li>CMD_IDX (bit 0-5)：命令索引，如 CMD0=0 (复位), CMD17=17 (单块读)。</li>
<li>CMD_RESP (bit 6-7)：响应类型，00=无响应, 01=R1/R3/R4/R5, 10=R2。</li>
<li>CMD_DATA (bit 8)：1=有数据传输。</li>
</ul>
<p>MMC_DATA_CTRL 寄存器位域：</p>
<ul>
<li>BLOCK_SIZE (bit 0-11)：数据块大小（512 字节=0x200）。</li>
<li>DMA_EN (bit 0)：1=使能 DMA 传输。</li>
<li>DIR (bit 1)：0=主机到卡（写），1=卡到主机（读）。</li>
</ul>
<p>MMC_INTR_EN 寄存器位域：</p>
<ul>
<li>TX_COMPLETE_EN (bit 0)：使能发送完成中断。</li>
<li>RX_COMPLETE_EN (bit 1)：使能接收完成中断。</li>
<li>ERR_INTR_EN (bit 2)：使能错误中断（如 CRC 错误）。</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../chapter7/7_1_sd_driver.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../chapter7/7_3_flash_driver.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../chapter7/7_1_sd_driver.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../chapter7/7_3_flash_driver.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
