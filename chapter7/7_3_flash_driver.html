<!DOCTYPE HTML>
<html lang="zh-CN" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Flash驱动 - 飞腾派驱动开发实验指导书</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">飞腾派驱动开发实验指导书</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="73-flash驱动"><a class="header" href="#73-flash驱动">7.3 Flash驱动</a></h1>
<h3 id="flash-设备原理"><a class="header" href="#flash-设备原理">Flash 设备原理</a></h3>
<p>Flash 存储器是一种非易失性半导体存储技术，能够在断电后保留数据，广泛用于嵌入式系统中的固件存储和数据持久化。Flash 原理基于浮栅晶体管（Floating Gate Transistor），通过隧道效应（Fowler-Nordheim Tunneling）或热电子注入在浮栅上存储电荷，表示 0/1 状态。Flash 分两种类型：NOR Flash 支持随机访问和执行代码（XIP），适用于固件启动；NAND Flash 支持块访问，高密度低成本，适用于数据存储，但需错误纠正（ECC）和坏块管理。Flash 操作包括读、写（编程）和擦除：读操作直接访问单元；写操作注入电荷到浮栅，通常以页（2K~16K 字节）为单位；擦除操作移除电荷，以块（64K~512K 字节）为单位，必须先擦除再写。Flash 寿命有限（10K~100K 次擦除），使用磨损均衡算法延长使用。接口包括 SPI（串行外围接口）用于低速小容量 Flash 和 Parallel 接口用于高速大容量。</p>
<ul>
<li>关键特性：
<ul>
<li><strong>读速度</strong>：NOR Flash ~100 MB/s，NAND Flash ~200 MB/s。</li>
<li><strong>写/擦除时间</strong>：写页 200µs~2ms，擦除块 1~5ms。</li>
<li><strong>电压</strong>：1.8V~3.3V，支持低功耗模式。</li>
<li><strong>错误处理</strong>：内置 CRC 或 ECC，坏块标记。</li>
</ul>
</li>
</ul>
<p>Flash 与 EEPROM 的区别在于块擦除而非字节擦除，适用于飞腾派等嵌入式板卡的 boot loader 和文件系统。</p>
<hr />
<h3 id="飞腾派-flash-设备"><a class="header" href="#飞腾派-flash-设备">飞腾派 Flash 设备</a></h3>
<p>飞腾派（Phytium Pi）开发板的 Flash 设备使用 SPI NOR Flash（如 W25Q128JV），容量 16MB，支持 SPI 模式，用于存储固件和启动代码。设备控制器集成在 SPI 模块中，基址 0x2803A000，支持主模式、四种时序模式（CPOL/CPHA 组合）和最大 104 MHz 时钟速率，带宽 52 MB/s。飞腾派 Flash 设备通过 Mini-SPI 接口连接，支持 Quad SPI (4 位数据线) 提升性能，适用于 U-Boot 和 ArceOS 镜像存储。设备树（phytium_pi.dts）定义 spi-flash 节点，配置文件（aarch64-phytium-pi.toml）包含 MMIO 区域 [0x2803A000, 0x1000]。驱动在 ArceOS 中通过 axdriver_spi 模块实现，支持命令如读 ID (0x90)、页编程 (0x02) 和块擦除 (0xD8)，适用于 boot 和数据持久化。</p>
<ul>
<li>硬件特性：
<ul>
<li><strong>容量</strong>：16MB (128Mb)，页大小 256 字节，块大小 64KB。</li>
<li><strong>接口</strong>：SPI，支持 Single/Dual/Quad 模式，引脚 MISO/MOSI/SCK/CS 通过 PAD (0x32B30000) 配置。</li>
<li><strong>中断</strong>：IRQ 通过 GIC 路由（SPI 模式下可选）。</li>
<li><strong>扩展</strong>：支持外部 SD 卡扩展，但内置 Flash 用于固件。</li>
</ul>
</li>
</ul>
<p>飞腾派的 Flash 设备与 eMMC 不同，前者用于固件存储，后者用于大容量数据，驱动支持轮询和中断模式。</p>
<hr />
<h3 id="飞腾派-flash-设备时序图"><a class="header" href="#飞腾派-flash-设备时序图">飞腾派 Flash 设备时序图</a></h3>
<p>飞腾派 Flash 设备时序以页读操作（CMD 0x03）为例，涉及 SPI 控制器（基址 0x2803A000）、Flash 芯片和 SPI 总线（MISO/MOSI/SCK/CS）。主机发送 CMD 0x03 和地址，Flash 返回数据字节，完成后 CS 高电平结束传输。总延迟约 10~100 µs（104 MHz 时钟），依赖模式（Single SPI 1 位，Quad SPI 4 位）。</p>
<pre class="mermaid">sequenceDiagram
    participant Host as SPI 控制器 (0x2803A000)
    participant Flash as Flash 芯片
    participant Bus as SPI 总线 (MOSI/MISO/SCK/CS)

    Host-&gt;&gt;Bus: CS 低电平 (选中芯片)
    Host-&gt;&gt;Flash: 发送 CMD 0x03 (读命令)
    Host-&gt;&gt;Flash: 发送 24 位地址
    Flash-&gt;&gt;Bus: 返回数据字节 (MISO)
    Bus-&gt;&gt;Host: 数据到达 FIFO
    Host-&gt;&gt;Host: 触发中断 (可选, IRQ)
    Host-&gt;&gt;Bus: CS 高电平 (结束传输)
</pre>
<h4 id="时序分析"><a class="header" href="#时序分析">时序分析</a></h4>
<p>命令阶段：MOSI 发送 8 位命令 + 24 位地址（32 位总），响应延迟 &lt;1 µs。数据阶段：MISO 返回字节数据，4 位模式下速率 52 MB/s，CRC 校验完整性。中断阶段：传输完成后控制器触发 IRQ，通过 GIC 路由到 CPU 0。</p>
<hr />
<h2 id="相关寄存器信息位域及基地址"><a class="header" href="#相关寄存器信息位域及基地址">相关寄存器信息、位域及基地址</a></h2>
<p>飞腾派 Flash 设备寄存器基于 SPI 控制器（基址 0x2803A000），支持命令、数据和中断配置。以下是关键寄存器、位域和基地址信息。</p>
<ul>
<li>
<p><strong>基址</strong>：SPI 控制器基址 0x2803A000。</p>
</li>
<li>
<p>寄存器表：</p>
<div class="table-wrapper"><table><thead><tr><th><strong>寄存器</strong></th><th><strong>偏移</strong></th><th><strong>功能</strong></th><th><strong>关键位域</strong></th></tr></thead><tbody>
<tr><td>SPICTRL0</td><td>0x000</td><td>控制寄存器 0</td><td>DATA_WIDTH (bit 0-3: 8/16 位), CPOL (bit 6), CPHA (bit 7)</td></tr>
<tr><td>SPIEN</td><td>0x008</td><td>使能寄存器</td><td>SPI_EN (bit 0: 1=使能)</td></tr>
<tr><td>SPIBAUDR</td><td>0x014</td><td>波特率寄存器</td><td>BAUDR (bit 0-31: 分频值, 104 MHz / BAUDR)</td></tr>
<tr><td>SPITXFTLR</td><td>0x018</td><td>发送 FIFO 阈值</td><td>TX_THR (bit 0-7: 阈值 0~255)</td></tr>
<tr><td>SPIRXFTLR</td><td>0x01C</td><td>接收 FIFO 阈值</td><td>RX_THR (bit 0-7: 阈值 0~255)</td></tr>
<tr><td>SPITXFLR</td><td>0x020</td><td>发送 FIFO 等级</td><td>TX_LVL (bit 0-7: 当前等级)</td></tr>
<tr><td>SPIRXFLR</td><td>0x024</td><td>接收 FIFO 等级</td><td>RX_LVL (bit 0-7: 当前等级)</td></tr>
<tr><td>SPISR</td><td>0x028</td><td>状态寄存器</td><td>BUSY (bit 0: 1=忙), TFNF (bit 1: TX FIFO 非满)</td></tr>
<tr><td>SPIIMR</td><td>0x02C</td><td>中断屏蔽寄存器</td><td>TXEI (bit 2: TX 阈值中断), RXFI (bit 4: RX 阈值中断)</td></tr>
<tr><td>SPIISR</td><td>0x030</td><td>中断状态寄存器</td><td>TXEI (bit 2), RXFI (bit 4)</td></tr>
<tr><td>SPIRISR</td><td>0x034</td><td>原始中断状态寄存器</td><td>TXEI (bit 2), RXFI (bit 4)</td></tr>
<tr><td>SPIICR</td><td>0x048</td><td>中断清除寄存器</td><td>CLR_ALL (bit 0: 写 1 清所有中断)</td></tr>
<tr><td>SPIDMACR</td><td>0x04C</td><td>DMA 控制寄存器</td><td>DMA_EN (bit 0: 1=使能 DMA)</td></tr>
<tr><td>SPIDR</td><td>0x060</td><td>数据寄存器</td><td>DR (bit 0-7/15: 数据字节)</td></tr>
<tr><td>SPIRXSAMPLEDLY</td><td>0x0FC</td><td>接收采样延迟</td><td>DELAY (bit 0-7: 采样延迟周期)</td></tr>
<tr><td>SPICS</td><td>0x100</td><td>片选寄存器</td><td>CS (bit 0: 0=选中，1=释放)</td></tr>
</tbody></table>
</div></li>
</ul>
<p>SPICTRL0 寄存器位域：</p>
<ul>
<li>DATA_WIDTH (bit 0-3)：数据位宽，3=8 位, 4=16 位。</li>
<li>CPOL (bit 6)：时钟极性，0=空闲低电平, 1=空闲高电平。</li>
<li>CPHA (bit 7)：时钟相位，0=第一个边沿采样, 1=第二个边沿采样。</li>
</ul>
<p>SPIEN 寄存器位域：</p>
<ul>
<li>SPI_EN (bit 0)：1=使能 SPI 控制器。</li>
</ul>
<p>SPIBAUDR 寄存器位域：</p>
<ul>
<li>BAUDR (bit 0-31)：分频值，速率 = 时钟 / BAUDR (104 MHz / BAUDR)。</li>
</ul>
<p>SPIIMR 寄存器位域：</p>
<ul>
<li>TXEI (bit 2)：发送阈值中断使能。</li>
<li>RXFI (bit 4)：接收阈值中断使能。</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../chapter7/7_2_emmc_driver.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../chapter8/chapter_8.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../chapter7/7_2_emmc_driver.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../chapter8/chapter_8.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>



    </div>
    </body>
</html>
